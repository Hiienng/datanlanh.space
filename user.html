<!DOCTYPE html>
<html lang="vi">
  <head>
  <meta charset="UTF-8" />
  <title>Quản lý người dùng - R.E.A.L</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <link rel="stylesheet" href="styles.css" />
    <script type="text/javascript">
      // Keep API base consistent with galleries.html. Dev line overrides prod.
      window.API_BASE = 'https://trueland.onrender.com';
      window.API_BASE = 'http://127.0.0.1:8000';
    </script>
  </head>
<body>
  <!-- NAV replicated from galleries.html -->
  <nav class="px-3 py-2 sm:px-4 sm:py-3 md:px-6 md:py-4">
    <div class="max-w-7xl mx-auto">
      <div class="glass-elevated rounded-xl sm:rounded-2xl px-3 py-2 sm:px-4 sm:py-3 md:px-6 md:py-4 flex items-center justify-between gap-2">
        <!-- Brand -->
        <a href="index.html" class="flex items-center gap-2 sm:gap-3 min-w-0">
          <img src="https://ik.imagekit.io/o2u9hny2s/trueland/trueland_icon.png" alt="R.E.A.L" class="h-8 w-8 sm:h-10 sm:w-10 md:h-12 md:w-12 object-contain shrink-0"/>
          <div class="leading-tight truncate">
            <p class="text-[15px] sm:text-[18px] lg:text-[20px] uppercase tracking-wider font-bold text-white/90">R.E.A.L</p>
          </div>
        </a>

        <!-- Tabs + actions (desktop) -->
        <div class="flex items-center gap-2 sm:gap-3">
          <div role="tablist" class="hidden sm:flex items-center gap-2">
            <a href="galleries.html" class="tab-btn tab-btn--sm" role="tab" aria-selected="false">Sản phẩm</a>
            <a href="galleries.html" class="tab-btn tab-btn--sm" role="tab" aria-selected="false">AI tư vấn quy trình</a>
            <a href="galleries.html" class="tab-btn tab-btn--sm" role="tab" aria-selected="false">Giải pháp tài chính</a>

            <!-- Account/Login -->
            <button id="accountBtn" class="hidden rounded-full border border-blue-200/60 px-3 py-1 text-blue-700 bg-white/70 transition hover:bg-blue-50">
              <i class="fas fa-user mr-1"></i><span>Account</span>
            </button>
          </div>

          <!-- Mobile hamburger -->
          <button id="navMenuBtn" class="sm:hidden inline-flex items-center justify-center h-9 w-9 rounded-lg border border-white/30 text-white/90" aria-expanded="false" aria-controls="mobileMenu" aria-label="Open menu">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
              <path d="M3 6h18v2H3V6zm0 5.5h18v2H3v-2zM3 17h18v2H3v-2z"/>
            </svg>
          </button>

          <!-- Mobile drawer -->
          <div id="mobileMenu" class="sm:hidden hidden">
            <div id="navOverlay" class="nav-overlay"></div>
            <aside class="mobile-drawer" role="dialog" aria-modal="true" aria-label="Mobile menu">
              <div class="drawer-header flex items-center justify-between px-4 py-3 border-b">
                <div class="flex items-center gap-2">
                  <img src="https://ik.imagekit.io/o2u9hny2s/trueland/trueland_icon.png" alt="R.E.A.L" class="h-8 w-8 object-contain"/>
                  <span class="font-semibold text-slate-800">Menu</span>
                </div>
                <button id="drawerCloseBtn" class="text-slate-700 hover:text-slate-900 font-semibold" aria-label="Close menu">
                  <span class="text-xl" aria-hidden="true">&times;</span>
                  <span class="ml-2">Đóng</span>
                </button>
              </div>
              <div class="drawer-content p-4">
                <div id="drawerScreenMenu" class="drawer-screen h-full flex flex-col">
                  <div class="MobileNavContent">
                    <nav class="MegaMenuWrapper mobile">
                      <div class="MegaMenu active">
                        <div class="MegaMenu__Selector">
                          <p class="MegaMenu__Title">Khám phá</p>
                          <div class="MegaMenu__Caret" tabindex="0"></div>
                        </div>
                        <div class="MegaMenu__Dropdown">
                          <div class="MenuList">
                            <a class="mobile-tab-item" href="galleries.html">Gallery</a>
                            <a class="mobile-tab-item" href="galleries.html">Broker Services</a>
                            <a class="mobile-tab-item" href="galleries.html">Lawyer Services</a>
                            <a class="mobile-tab-item" href="galleries.html">Financial Services</a>
                          </div>
                        </div>
                      </div>
                      <div class="MegaMenu">
                        <div class="MegaMenu__Selector">
                          <p class="MegaMenu__Title">Tài khoản</p>
                          <div class="MegaMenu__Caret" tabindex="0"></div>
                        </div>
                        <div class="MegaMenu__Dropdown">
                          <div class="MenuList">
                            <button class="accountBtn MenuLink hidden"><i class="fas fa-user mr-2"></i>Account</button>
                          </div>
                        </div>
                      </div>
                    </nav>
                  </div>
                </div>
              </div>
            </aside>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <main class="max-w-7xl mx-auto px-4 md:px-6 py-6">
    <h1 class="text-2xl font-bold text-white mb-4">Quản lý người dùng</h1>
    
    <div class="glass rounded-2xl p-4 mb-6 flex items-center justify-between">
      <p class="text-slate-700 text-sm">Tài khoản: <span id="umEmail" class="font-semibold"></span></p>
      <div class="flex items-center gap-2">
        <button id="btnLogout" class="btn-secondary"><i class="fas fa-sign-out-alt mr-1"></i>Đăng xuất</button>
      </div>
    </div>

    <div class="glass rounded-2xl p-4">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold text-slate-800">Tài sản đã tạo</h2>
        <button id="assetsToggleBtn" class="btn-secondary">Ẩn/Hiện</button>
      </div>
      <div id="assetsSection" class="filter-section mb-4">
        <div class="flex items-center justify-between mb-3">
          <a id="btnCreateAsset" href="galleries.html?create=1" class="btn-primary"><i class="fas fa-plus mr-2"></i>Tạo tài sản</a>
        </div>
        <div id="myListings" class="grid gap-4 md:grid-cols-2 lg:grid-cols-3"></div>
      </div>
    </div>
  </main>

  <!-- Edit modal -->
  <div id="editModal" class="fixed inset-0 z-50 hidden">
    <div id="emOverlay" class="absolute inset-0 bg-black/50"></div>
    <div class="relative mx-auto my-8 max-w-3xl bg-white rounded-2xl p-6 shadow-2xl cam-panel">
      <button id="emClose" class="absolute right-4 top-3 text-slate-500 hover:text-slate-800" aria-label="Đóng">&times;</button>
      <h3 class="text-xl font-bold mb-4">Chỉnh sửa tài sản</h3>
      <form id="editForm" class="grid gap-4 md:grid-cols-2">
        <input type="hidden" id="em_id" />
        <div class="md:col-span-2"><label class="text-sm font-medium">Tiêu đề</label><input id="em_title" required></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Mô tả</label><textarea id="em_description" rows="3"></textarea></div>
        <div><label class="text-sm font-medium">Giá (VND)</label><input id="em_price" type="number" step="0.01"></div>
        <div><label class="text-sm font-medium">Diện tích (m²)</label><input id="em_square" type="number" step="0.01"></div>
        <div class="md:col-span-2"><label class="text-sm font-medium">Ảnh header</label><input id="em_header" type="file" accept="image/*"></div>
        <div class="md:col-span-2 flex justify-end gap-2 mt-2">
          <button type="button" id="emCancel" class="btn-secondary">Hủy</button>
          <button type="submit" class="btn-primary">Lưu</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // API base
    const API_BASE = (function(){
      const env = window.API_BASE || window.API_BASE;
      if (env) return env.replace(/\/$/, '');
      const host = location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:8000';
      return '/api';
    })();
    function getToken(){ return localStorage.getItem('access_token')||'' }
    function getEmail(){ return localStorage.getItem('user_email')||'' }
    function logout(){ localStorage.clear(); location.href='index.html' }
    document.getElementById('btnLogout')?.addEventListener('click', logout);

    // Nav: show Account after login
    function updateUIAfterLogin(email){
      document.querySelectorAll('.accountBtn, #accountBtn').forEach(el => el.classList.remove('hidden'));
    }
    document.getElementById('accountBtn')?.addEventListener('click', ()=>{ location.href='user.html'; });
    document.querySelectorAll('.accountBtn').forEach(el => el.addEventListener('click', ()=>{ location.href='user.html'; }));

    // Mobile menu toggle - ✅ FIXED CLOSING BRACE
    (function initUserNav(){
      const btn  = document.getElementById('navMenuBtn');
      const menu = document.getElementById('mobileMenu');
      const overlay = document.getElementById('navOverlay');
      if(!btn || !menu) return;
      
      function close(){ 
        menu.classList.add('hidden'); 
        menu.classList.remove('open'); 
        document.body.classList.remove('drawer-open'); 
        btn.setAttribute('aria-expanded','false'); 
      }
      
      function open(){ 
        menu.classList.remove('hidden'); 
        menu.classList.add('open'); 
        document.body.classList.add('drawer-open'); 
        btn.setAttribute('aria-expanded','true'); 
      }
      
      btn.addEventListener('click', ()=>{ menu.classList.contains('open') ? close() : open(); });
      document.getElementById('drawerCloseBtn')?.addEventListener('click', close);
      overlay?.addEventListener('click', close);
      document.addEventListener('click', (e)=>{ 
        if(menu.classList.contains('open') && !menu.contains(e.target) && !btn.contains(e.target)) close(); 
      });
    })(); // ✅ FIXED: Added closing parenthesis

    // Toggle assets section
    document.getElementById('assetsToggleBtn')?.addEventListener('click', ()=>{
      const sec = document.getElementById('assetsSection');
      if (!sec) return;
      sec.classList.toggle('collapsed');
    });

    // Fetch helper
    async function fetchJSON(url, opts={}){
      const res = await fetch(url, opts);
      const data = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(data.detail || ('HTTP '+res.status));
      return data;
    }

    // Profile + listings
    async function loadProfile(){
      const token=getToken(); 
      if(!token){ 
        alert('Vui lòng đăng nhập'); 
        location.href='index.html'; 
        return;
      }
      const me = await fetchJSON(`${API_BASE}/me`, { headers:{ 'Authorization':`Bearer ${token}` } });
      const email = me.email || getEmail() || '';
      const phone = me.phone_number || me.phone || me.mobile || me.telephone || me.tel || me.sdt || '';
      document.getElementById('umEmail').textContent = phone ? `${email} | ${phone}` : email;
      try { if (phone) localStorage.setItem('user_phone', phone); } catch {}
    }

    function listingCard(l){
      const userId = l.user_id || '';
      const v = encodeURIComponent(l.image_version || l.created_at || '');
      const img = userId ? `https://ik.imagekit.io/o2u9hny2s/trueland/users/${userId}/header.jpg?v=${v}` : 'https://ik.imagekit.io/o2u9hny2s/trueland/trueland_icon.png';
      return `
        <div class="product-card p-4">
          <div class="rounded-xl overflow-hidden mb-3 bg-slate-100">
            <img src="${img}" class="w-full h-40 object-cover" onerror="this.onerror=null;this.src='https://ik.imagekit.io/o2u9hny2s/trueland/trueland_icon.png'"/>
          </div>
          <div class="flex items-start justify-between gap-2">
            <h3 class="font-bold text-slate-900 line-clamp-2">${l.title||''}</h3>
            <span class="text-xs px-2 py-1 rounded bg-blue-100 text-blue-700">${l.listing_type||''}</span>
          </div>
          <p class="text-sm text-slate-600 line-clamp-2 mb-2">${l.description||''}</p>
          <div class="flex items-center justify-between text-sm">
            <span class="font-semibold text-blue-600">${l.price? Number(l.price).toLocaleString('vi-VN')+' VND':''}</span>
            <span>${l.square? Number(l.square).toLocaleString('vi-VN')+' m²':''}</span>
          </div>
          <div class="flex justify-end gap-2 mt-3">
            <button class="btn-secondary btn--sm" onclick="event.stopPropagation(); openEdit(${l.listing_id})"><i class="fas fa-pen mr-1"></i>Sửa</button>
            <button class="btn-primary btn--sm" onclick="event.stopPropagation(); removeListing(${l.listing_id})"><i class="fas fa-trash mr-1"></i>Xóa</button>
          </div>
        </div>`;
    }

    async function loadMyListings(){
      const token = getToken();
      const box = document.getElementById('myListings');
      if (!box) return;
      if (!token){
        box.innerHTML = '<div class="text-slate-500 text-sm">Vui lòng đăng nhập để xem tài sản của bạn.</div>';
        return;
      }
      try {
        const data = await fetchJSON(`${API_BASE}/me/listings`, { headers:{ 'Authorization': `Bearer ${token}` } });
        const items = Array.isArray(data) ? data.filter(l => (l && l.status !== 'deleted')) : [];
        if (items.length === 0){
          box.innerHTML = '<div class="text-slate-500 text-sm">Bạn chưa có tài sản nào. <a href="galleries.html" class="text-blue-600 underline">Tạo tài sản</a></div>';
        } else {
          box.innerHTML = items.map(listingCard).join('');
        }
      } catch (err) {
        const msg = String(err?.message || '');
        if (/401/.test(msg) || /Unauthorized/i.test(msg)){
          alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
          location.href = 'index.html';
          return;
        }
        box.innerHTML = `<div class="text-red-600 text-sm">Không thể tải danh sách: ${msg}</div>`;
      }
    }

    // Edit flow
    window.openEdit = async function(id){
      const l = await fetchJSON(`${API_BASE}/listings/${id}`, {});
      document.getElementById('em_id').value = id;
      document.getElementById('em_title').value = l.title || '';
      document.getElementById('em_description').value = l.description || '';
      document.getElementById('em_price').value = l.price || '';
      document.getElementById('em_square').value = l.square || '';
      document.getElementById('editModal').classList.remove('hidden');
      document.body.classList.add('drawer-open');
    };
    
    window.removeListing = async function(id){
      try {
        if (!confirm('Bạn chắc chắn muốn xóa?')) return;
        const token = getToken();
        await fetchJSON(`${API_BASE}/listings/${id}`, { method:'DELETE', headers:{ 'Authorization': `Bearer ${token}` } });
        await loadMyListings();
      } catch (err) {
        const msg = String(err?.message || '');
        if (/401/.test(msg) || /Unauthorized/i.test(msg)){
          alert('Phiên đăng nhập đã hết hạn. Vui lòng đăng nhập lại.');
          location.href = 'index.html';
          return;
        }
        alert('Không thể xóa: ' + msg);
        console.error('[removeListing]', err);
      }
    };
    
    document.getElementById('emOverlay')?.addEventListener('click', ()=>{ document.getElementById('editModal').classList.add('hidden'); document.body.classList.remove('drawer-open'); });
    document.getElementById('emClose')?.addEventListener('click', ()=>{ document.getElementById('editModal').classList.add('hidden'); document.body.classList.remove('drawer-open'); });
    document.getElementById('emCancel')?.addEventListener('click', ()=>{ document.getElementById('editModal').classList.add('hidden'); document.body.classList.remove('drawer-open'); });
    
    document.getElementById('editForm')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const token=getToken();
      const id = document.getElementById('em_id').value;
      const payload = {
        title: document.getElementById('em_title').value.trim(),
        description: document.getElementById('em_description').value.trim(),
        listing_type: undefined, asset_type: undefined, asset_subtype: undefined, asset_legaltype: undefined,
        price: document.getElementById('em_price').value || null,
        square: document.getElementById('em_square').value || null,
        province: undefined, city: undefined, district: undefined,
        main_street: undefined, main_street_width: undefined,
        alley: undefined, alley_width: undefined, mattien: undefined,
        google_map_id: undefined, thua_dat_id: undefined, to_ban_do_id: undefined,
      };
      await fetchJSON(`${API_BASE}/listings/${id}`, { method:'PUT', headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${token}` }, body: JSON.stringify(payload) });
      const f = document.getElementById('em_header');
      if (f.files && f.files[0]){
        const fd = new FormData(); fd.append('file', f.files[0], f.files[0].name);
        await fetchJSON(`${API_BASE}/listings/${id}/header-image`, { method:'POST', headers:{ 'Authorization':`Bearer ${token}` }, body: fd });
      }
      document.getElementById('editModal').classList.add('hidden'); 
      document.body.classList.remove('drawer-open');
      await loadMyListings();
    });

    // Boot
    (async function(){
      try {
        if (getToken()) updateUIAfterLogin(getEmail());
        await loadProfile();
        await loadMyListings();
      } catch (e) {
        const msg = String(e?.message || '');
        if (/401/.test(msg) || /Unauthorized/i.test(msg)){
          try { localStorage.removeItem('access_token'); } catch {}
          alert('Session expired. Please login again.');
          location.href = 'index.html';
          return;
        }
        console.error(e);
      }
    })();
  </script>
</body>
</html>

