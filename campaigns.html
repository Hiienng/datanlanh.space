<!-- Trang này để đăng thông tin campaigns -->
<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tạo Chiến Dịch - HopeSeed</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<head>
  <meta charset="UTF-8" />
  <title>Hope Seed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxuvwv/b4jzlGC62Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      color-scheme: light;
      --accent: #34b3d3;
      --accent-strong: #0284c7;
      --accent-dark: #1e3a8a;
      --accent-soft: rgba(2, 132, 199, 0.12);
      --card-bg: #f0f9ff;
      --card-border: rgba(2, 132, 199, 0.2);
    }
    html, body { width: 100%; overflow-x: hidden; }
    body{
      font-family: 'Plus Jakarta Sans','Inter',
                  'Be Vietnam Pro','Noto Sans','Segoe UI',system-ui,-apple-system,sans-serif;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
      font-feature-settings: "liga","calt","ss01","cv05";
      background: linear-gradient(125deg, #e0f2fe 0%, #bae6fd 45%, #ffffff 100%); color: #083344;
    }
    :root{
      --lh-tight: 1.15;
      --lh-normal: 1.6;
    }
    .glass-card {
      background: rgba(240, 249, 255, 0.94);
      backdrop-filter: blur(22px);
      border: 1px solid var(--card-border);
      box-shadow: 0 28px 55px -28px rgba(2, 132, 199, 0.35);
    }
    .dashboard-backdrop { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    .dashboard-backdrop div { position: absolute; border-radius: 9999px; filter: blur(120px); opacity: 0.65; }
    .dashboard-backdrop div:nth-child(1){ width:540px; height:540px; background: rgba(2,132,199,.32); top:-120px; left:-140px;}
    .dashboard-backdrop div:nth-child(2){ width:480px; height:480px; background: rgba(125,211,252,.28); bottom:-160px; right:-120px;}
    .dashboard-backdrop div:nth-child(3){ width:380px; height:380px; background: rgba(147,197,253,.24); top:38%; right:28%;}
    .bg-blue-500 { background-color: var(--accent) !important; }
    .hover\:bg-blue-600:hover { background-color: var(--accent-dark) !important; }
    .bg-blue-50 { background-color: var(--accent-soft) !important; }
    .text-blue-600 { color: var(--accent-strong) !important; }
    .text-blue-700 { color: var(--accent-dark) !important; }
    .border-blue-200 { border-color: rgba(2,132,199,.42) !important; }
    .border-blue-200\/60 { border-color: rgba(2,132,199,.28) !important; }
    .ring-blue-200 { --tw-ring-color: rgba(2,132,199,.28) !important; }
    .shadow-blue-500\/40 { box-shadow: 0 18px 48px rgba(2,132,199,.32) !important; }

    /* Simple modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; z-index: 50; }
    .modal-backdrop.show { display: flex; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <div class="dashboard-backdrop" aria-hidden="true"></div>

  <!-- NAV -->
  <nav class="max-w-6xl mx-auto px-6 pt-8">
    <div class="glass-card rounded-3xl px-6 py-5 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <a href="index.html" class="flex items-center gap-3">
        <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-blue-500 text-white text-lg font-semibold tracking-tight shadow-lg shadow-blue-500/40">HS</span>
        <div>
          <p class="text-xs uppercase tracking-[0.35em] text-blue-700" data-i18n="brand_tag">Hope Seed</p>
          <p class="text-base font-semibold text-slate-900" data-i18n="brand_title">Mảnh Vườn Hy Vọng</p>
        </div>
      </a>

      <div class="flex flex-wrap items-center gap-3 text-sm">
        <button id="langBtn" class="rounded-full border border-blue-200/60 bg-white/70 px-3 py-1 text-blue-700 hover:bg-blue-50 transition" title="Switch language">EN / VI</button>
        <span id="userInfo" class="rounded-full bg-blue-50 px-3 py-1 text-blue-700 border border-blue-200/60" data-i18n="not_logged">Chưa đăng nhập</span>
        <button id="logoutBtn" onclick="logout()" class="hidden rounded-full border border-red-200 px-3 py-1 text-red-600 transition hover:bg-red-50"><i class="fas fa-sign-out-alt mr-1"></i><span data-i18n="logout">Đăng xuất</span></button>
        <button id="loginToggleBtn" class="rounded-full bg-slate-900 px-4 py-2 text-white transition hover:bg-slate-800 shadow-lg shadow-slate-900/20"><i class="fas fa-sign-in-alt mr-1"></i><span data-i18n="login">Đăng nhập</span></button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto px-6 py-8">
    <!-- Campaign Creation Form -->
    <section class="glass-card rounded-3xl p-6 md:p-8 space-y-8 max-w-6xl mx-auto">
      <p>Nội dung này ưu tiên dành cho cán bộ y tế hoặc cá nhân được giới thiệu từ cán bộ y tế của bệnh viện.</p>
      <h2 class="text-2xl font-semibold text-gray-800 mb-6">Tạo Chiến Dịch Mới</h2>

      <form id="campaignForm" class="space-y-6">
        <!-- Patient Information -->
        <div>
          <label for="patient_id" class="block text-sm font-medium text-gray-700">Bệnh nhân</label>
          <select id="patient_id" name="patient_id" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400">
            <option value="">Chọn bệnh nhân</option>
            <!-- Options sẽ được nạp + 1 option đặc biệt ở cuối -->
          </select>
        </div>

        <!-- Hospital Information -->
        <div>
          <label for="hospital_id" class="block text-sm font-medium text-gray-700">Bệnh viện</label>
          <select id="hospital_id" name="hospital_id" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400">
            <option value="">Chọn bệnh viện</option>
            <!-- Options sẽ được nạp + 1 option đặc biệt ở cuối -->
          </select>
        </div>

        <!-- Campaign Type -->
        <div>
          <label for="main_type" class="block text-sm font-medium text-gray-700">Loại chiến dịch</label>
          <select id="main_type" name="main_type" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400">
            <option value="chữa bệnh">Quyên góp</option>
            <option value="ung bướu">Vay mượn có hoặc không hoàn lại</option>
          </select>
        </div>

        <!-- Financial Information -->
        <div>
          <label for="total_price_need" class="block text-sm font-medium text-gray-700">Tổng số tiền cần (VND)</label>
          <input type="number" id="total_price_need" name="total_price_need" min="0" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400" placeholder="Nhập số tiền">
        </div>

        <div>
          <label for="unit_price" class="block text-sm font-medium text-gray-700">Đơn vị thấp nhất (VND)</label>
          <input type="number" id="unit_price" name="unit_price" min="0" step="0.01" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400" placeholder="VD: 100000">
        </div>

        <!-- Description -->
        <div>
          <label for="description" class="block text-sm font-medium text-gray-700">Mô tả tình trạng và lý do cần được quyên góp</label>
          <textarea id="description" name="description" rows="5" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400" placeholder="Mô tả câu chuyện và lý do cần hỗ trợ"></textarea>
        </div>

        <!-- Media Upload -->
        <div>
          <label for="video_url" class="block text-sm font-medium text-gray-700">URL Video (tùy chọn)</label>
          <input type="url" id="video_url" name="video_url" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400" placeholder="Nhập URL video">
        </div>

        <div>
          <label for="media" class="block text-sm font-medium text-gray-700">Tải lên hình ảnh/tài liệu</label>
          <input type="file" id="media" name="media" accept="image/*,application/pdf" multiple class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-100 focus:border-blue-400">
        </div>

        <!-- Submit Button -->
        <div>
          <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-100">Tạo Chiến Dịch</button>
        </div>
        <p class="text-sm text-slate-600">Lưu ý: Cá nhân tạo chiến dịch huy động cam kết mọi thông tin đều chính xác và chịu trách nhiệm về tính pháp lý với thông tin sai sự thật.</p>
      </form>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-gray-800 text-white py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
      <p>&copy; 2025 Hope Seed. Mảnh Vườn Hy Vọng.</p>
    </div>
  </footer>

  <!-- Modal: Thêm bệnh nhân -->
  <div id="modalAddPatient" class="modal-backdrop">
    <div class="glass-card max-w-lg w-full rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Thêm bệnh nhân mới</h3>
        <button type="button" class="text-slate-600 hover:text-slate-900" data-close-patient>&times;</button>
      </div>
      <form id="addPatientForm" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Họ và tên</label>
          <input required name="full_name" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="VD: Nguyễn Văn A">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Ngày sinh</label>
            <input type="date" name="dob" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400">
          </div>
          <div>
            <label class="block text-sm mb-1">Số điện thoại</label>
            <input name="phone" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="09xxxxxxxx">
          </div>
        </div>
        <div>
          <label class="block text-sm mb-1">Địa chỉ</label>
          <input name="address" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="Quận/Huyện, Tỉnh/Thành">
        </div>

        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="px-4 py-2 rounded-md border" data-close-patient>Hủy</button>
          <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Lưu & chọn</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Yêu cầu kiểm duyệt bệnh viện -->
  <div id="modalRequestHospital" class="modal-backdrop">
    <div class="glass-card max-w-lg w-full rounded-2xl p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold">Yêu cầu kiểm duyệt bệnh viện</h3>
        <button type="button" class="text-slate-600 hover:text-slate-900" data-close-hospital>&times;</button>
      </div>
      <form id="requestHospitalForm" class="space-y-4">
        <div>
          <label class="block text-sm mb-1">Tên bệnh viện</label>
          <input required name="name" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="VD: Bệnh viện A">
        </div>
        <div>
          <label class="block text-sm mb-1">Địa chỉ</label>
          <input name="address" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="Số nhà, đường, phường/xã, quận/huyện, tỉnh/thành">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Khu vực/Region</label>
            <input name="region" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="VD: HN/HCM/ĐN...">
          </div>
          <div>
            <label class="block text-sm mb-1">Website (nếu có)</label>
            <input name="hospital_url" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="https://...">
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm mb-1">Người liên hệ</label>
            <input name="contact_person" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="Tên người liên hệ">
          </div>
          <div>
            <label class="block text-sm mb-1">Số liên hệ</label>
            <input name="contact_phone" class="w-full border rounded-md px-3 py-2 focus:ring-blue-100 focus:border-blue-400" placeholder="09xxxxxxxx">
          </div>
        </div>

        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button" class="px-4 py-2 rounded-md border" data-close-hospital>Đóng</button>
          <button type="submit" class="px-4 py-2 rounded-md bg-blue-600 text-white hover:bg-blue-700">Gửi yêu cầu</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = (function(){
  const env = window.HOPESEED_API_BASE; // optional build/runtime inject
  if (env) return env.replace(/\/$/, '');
  const host = location.hostname;
  if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:8000';
  return '/api';
})(); // Đổi nếu backend khác

    // Submit Campaign
    document.getElementById('campaignForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);

      // Upload media to ImageKit (lưu ý: production nên dùng signature phía server)
      const mediaFiles = formData.getAll('media');
      const mediaUrls = [];
      for (const file of mediaFiles) {
        const uploadFormData = new FormData();
        uploadFormData.append('file', file);
        uploadFormData.append('publicKey', 'public_SAebP074NOqF9MrOUtfIPGXmycA=');
        uploadFormData.append('fileName', file.name);

        try {
          const response = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
            method: 'POST',
            body: uploadFormData,
          });
          const result = await response.json();
          if (result.url) {
            mediaUrls.push({ kind: file.type.startsWith('image') ? 'image' : 'doc', url: result.url, title: file.name });
          }
        } catch (error) {
          console.error('Error uploading media:', error);
        }
      }

      const campaignData = {
        patient_id: parseInt(formData.get('patient_id')),
        hospital_id: parseInt(formData.get('hospital_id')),
        main_type: formData.get('main_type'),
        sub_type: formData.get('sub_type') || null,
        total_price_need: parseFloat(formData.get('total_price_need')),
        unit_price: parseFloat(formData.get('unit_price')) || null,
        description: formData.get('description'),
        video_url: formData.get('video_url') || null,
        media: mediaUrls,
      };

      try {
        const response = await fetch(`${API_BASE}/campaigns`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(campaignData),
        });
        const result = await response.json();
        if (response.ok) {
          alert('Chiến dịch đã được tạo thành công!');
          window.location.href = '/';
        } else {
          alert('Lỗi khi tạo chiến dịch: ' + (result.message || response.status));
        }
      } catch (error) {
        console.error('Error creating campaign:', error);
        alert('Đã có lỗi xảy ra. Vui lòng thử lại.');
      }
    });

    // Populate dropdowns + thêm option đặc biệt
    async function populateDropdowns() {
      try {
        const [patientsResponse, hospitalsResponse] = await Promise.all([
          fetch(`${API_BASE}/patients`),
          fetch(`${API_BASE}/hospitals`),
        ]);

        const patients = await patientsResponse.json();
        const hospitals = await hospitalsResponse.json();

        const patientSelect = document.getElementById('patient_id');
        patients.forEach(patient => {
          const option = document.createElement('option');
          option.value = patient.patient_id;
          option.textContent = patient.full_name || `Bệnh nhân ${patient.patient_id}`;
          patientSelect.appendChild(option);
        });
        // Option đặc biệt: thêm bệnh nhân
        const addPatientOpt = document.createElement('option');
        addPatientOpt.value = '__add_patient__';
        addPatientOpt.textContent = '+ Thêm bệnh nhân mới…';
        addPatientOpt.className = 'text-blue-700';
        patientSelect.appendChild(addPatientOpt);

        const hospitalSelect = document.getElementById('hospital_id');
        hospitals.forEach(hospital => {
          const option = document.createElement('option');
          option.value = hospital.hospital_id;
          option.textContent = hospital.name;
          hospitalSelect.appendChild(option);
        });
        // Option đặc biệt: yêu cầu kiểm duyệt
        const reqHospOpt = document.createElement('option');
        reqHospOpt.value = '__request_hospital__';
        reqHospOpt.textContent = '⏳ Yêu cầu kiểm duyệt bệnh viện…';
        reqHospOpt.className = 'text-blue-700';
        hospitalSelect.appendChild(reqHospOpt);

      } catch (error) {
        console.error('Error fetching dropdown data:', error);
      }
    }

    // Modal helpers
    function showModal(el) { el.classList.add('show'); }
    function hideModal(el) { el.classList.remove('show'); }

    // Open modals on special option select
    document.getElementById('patient_id').addEventListener('change', (e) => {
      if (e.target.value === '__add_patient__') {
        e.target.value = ''; // reset select
        showModal(document.getElementById('modalAddPatient'));
      }
    });

    document.getElementById('hospital_id').addEventListener('change', (e) => {
      if (e.target.value === '__request_hospital__') {
        e.target.value = ''; // reset select
        showModal(document.getElementById('modalRequestHospital'));
      }
    });

    // Close modal buttons
    document.querySelectorAll('[data-close-patient]').forEach(btn => {
      btn.addEventListener('click', () => hideModal(document.getElementById('modalAddPatient')));
    });
    document.querySelectorAll('[data-close-hospital]').forEach(btn => {
      btn.addEventListener('click', () => hideModal(document.getElementById('modalRequestHospital')));
    });

    // Submit: Add Patient then append to dropdown and select
    document.getElementById('addPatientForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        full_name: fd.get('full_name'),
        dob: fd.get('dob') || null,
        phone: fd.get('phone') || null,
        address: fd.get('address') || null,
      };

      try {
        const res = await fetch(`${API_BASE}/patients`, { // <-- đổi nếu endpoint khác
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.message || 'Create patient failed');

        const { patient_id, full_name } = result;
        const select = document.getElementById('patient_id');

        // chèn trước option đặc biệt cuối cùng
        const special = select.querySelector('option[value="__add_patient__"]');
        const newOpt = document.createElement('option');
        newOpt.value = patient_id;
        newOpt.textContent = full_name || `Bệnh nhân ${patient_id}`;
        select.insertBefore(newOpt, special);
        select.value = String(patient_id);

        hideModal(document.getElementById('modalAddPatient'));
        e.target.reset();
        alert('Đã thêm bệnh nhân mới.');
      } catch (err) {
        console.error(err);
        alert('Không thể thêm bệnh nhân. Vui lòng thử lại.');
      }
    });

    // Submit: Request hospital review
    document.getElementById('requestHospitalForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const payload = {
        name: fd.get('name'),
        address: fd.get('address') || null,
        region: fd.get('region') || null,
        hospital_url: fd.get('hospital_url') || null,
        contact_person: fd.get('contact_person') || null,
        contact_phone: fd.get('contact_phone') || null,
      };

      try {
        const res = await fetch(`${API_BASE}/hospitals/review-requests`, { // <-- đổi nếu endpoint khác
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        const result = await res.json();
        if (!res.ok) throw new Error(result.message || 'Submit request failed');

        hideModal(document.getElementById('modalRequestHospital'));
        e.target.reset();
        alert('Đã gửi yêu cầu kiểm duyệt bệnh viện. Cảm ơn bạn!');
      } catch (err) {
        console.error(err);
        alert('Không thể gửi yêu cầu. Vui lòng thử lại.');
      }
    });

    populateDropdowns();
  </script>
</body>
</html>
