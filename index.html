<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>R.E.A.L</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;600;700&family=Sora:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxuvwv/b4jzlGC62Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="icon" href="https://ik.imagekit.io/o2u9hny2s/trueland/trueland_icon.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script type="text/javascript">
    window.API_BASE = 'https://trueland.onrender.com';
    window.API_BASE = 'http://127.0.0.1:8000';
    // --- HTTP helper dùng chung (toàn cục) ---
    window.httpPost = async function(url, body){
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if (!res.ok) {
        let msg = `HTTP ${res.status} ${res.statusText}`;
        try { const j = await res.json(); if (j && j.detail) msg = j.detail; } catch {}
        throw new Error(msg);
      }
      return res.json();
    };
    /* === XLSX helpers (nếu bạn dùng) === */
    var gk_isXlsx = false;
    var gk_xlsxFileLookup = {};
    var gk_fileData = {};
    function filledCell(cell) { return cell !== '' && cell != null; }
    function loadFileData(filename) {
      if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
        try {
          var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
          var firstSheetName = workbook.SheetNames[0];
          var worksheet = workbook.Sheets[firstSheetName];
          var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
          var filteredData = jsonData.filter(row => row.some(filledCell));
          var headerRowIndex = filteredData.findIndex((row, index) =>
            row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
          );
          if (headerRowIndex === -1 || headerRowIndex > 25) headerRowIndex = 0;
          var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
          csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
          return csv;
        } catch (e) { console.error(e); return ""; }
      }
      return gk_fileData[filename] || "";
    }
  </script>
</head>

<body class="relative text-slate-700">
  <!-- Background glow -->
  <div class="dashboard-backdrop" aria-hidden="true">
    <div></div><div></div><div></div>
  </div>

  <div class="relative z-10">
    <!-- NAV -->
    <nav class="max-w-6xl mx-auto px-6 pt-8">
      <div class="glass-card rounded-3xl px-6 py-5 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <a href="index.html" class="flex items-center gap-3">
          <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl">
                <img src="https://ik.imagekit.io/o2u9hny2s/trueland/trueland_icon.png"
                 alt="logo" class="h-full w-full object-contain bg-transparent" loading="lazy"/>
          </span>
          <div>
            <p class="text-xs uppercase tracking-[0.35em] text-black-700" data-i18n="brand_tag">R.E.A.L</p>
            <p class="text-base font-semibold text-slate-900" data-i18n="brand_title">Sàn giao dịch P2P</p>
          </div>
        </a>
        <div class="flex flex-wrap items-center gap-3 text-sm">
          <button id="langBtn" class="rounded-full border border-blue-200/60 bg-white/70 px-3 py-1 text-blue-700 hover:bg-blue-50 transition" title="Switch language">EN / VI</button>
          <!-- <span id="userInfo" class="rounded-full bg-blue-50 px-3 py-1 text-blue-700 border border-blue-200/60" data-i18n="not_logged">Chưa đăng nhập</span> -->
          <button id="accountBtn" class="hidden rounded-full border border-blue-200/60 bg-white/70 px-3 py-1 text-blue-700 transition hover:bg-blue-50">
            <i class="fas fa-user mr-1"></i><span>Account</span>
          </button>
          <button id="loginToggleBtn" class="rounded-full bg-slate-900 px-4 py-2 text-white transition hover:bg-slate-800 shadow-lg shadow-slate-900/20">
            <i class="fas fa-sign-in-alt mr-1"></i><span data-i18n="login">Đăng nhập/Đăng ký</span>
          </button>
        </div>
      </div>
    </nav>
    <!-- HERO -->
    <header class="max-w-6xl mx-auto px-6 pt-12">
      <div class="grid gap-12 lg:grid-cols-[1.05fr,0.95fr] items-center">
        <div class="space-y-6">
          <span class="inline-flex items-center gap-2 rounded-full bg-white/80 px-4 py-1 text-sm font-medium text-blue-600 shadow-sm ring-1 ring-blue-200">#real</span>
          <span class="inline-flex items-center gap-2 rounded-full bg-white/80 px-4 py-1 text-sm font-medium text-blue-600 shadow-sm ring-1 ring-blue-200">#accountability</span>
            <h2 class="text-5xl md:text-6xl font-bold text-left leading-tight tracking-wider text-[#1e3a8a] font-['Playfair_Display'] drop-shadow-sm" data-i18n="hero_h1">  </h2>
          <span class="block text-lg text-left text-slate-600" data-i18n="hero_p">Nền tảng giao dịch bất động sản P2P minh bạch, an toàn và hiệu quả</span>  
          </span>
          <div class="flex flex-wrap items-center gap-3">
          <button type="button"
            class="btn-flat rounded-full px-6 py-3 font-medium shadow-lg transition hover:-translate-y-0.5"
            onclick="window.location.href='galleries.html'">
            <i class="fas fa-hand-holding-heart mr-1"></i>
            <span data-i18n="cta_more">Xem các câu chuyện hy vọng ✨</span>
          </button>
          </div>

          <dl class="grid grid-cols-2 gap-6 pt-2 sm:max-w-lg">
            <div>
              <dt class="text-[11px] leading-[var(--lh-tight)] text-slate-500" data-i18n="stat_donors_label">Người ủng hộ</dt>
              <dd class="text-2xl font-semibold text-slate-900" id="stat_donors">12k</dd>
            </div>
            <div>
              <dt class="text-xs uppercase tracking-wide text-slate-500" data-i18n="stat_fund_label">Chiến dịch tin cậy</dt>
              <dd class="text-2xl font-semibold text-slate-900" id="stat_funds">100</dd>
            </div>
          </dl>
        </div>

        <!-- Right images -->
        <div class="relative">
          <div class="hero-glow hidden lg:block" aria-hidden="true"></div>
          <div class="glass-card--transparent overflow-hidden rounded-[32px] ring-1 ring-white/40">
            <img src="https://ik.imagekit.io/o2u9hny2s/hopeseed/IMA5-1.png"
                 alt="Vietnam map" class="h-full w-full object-contain bg-transparent" loading="lazy"/>
          </div>
          <div class="absolute top-6 -right-6 hidden rounded-2xl bg-white/85 p-4 shadow-lg shadow-blue-500/20 lg:flex lg:flex-col lg:gap-1">
            <span class="text-xs uppercase tracking-wide text-blue-600" data-i18n="hero_widget_title">Chiến dịch đang hoạt động</span>
            <strong class="text-lg font-semibold text-slate-900" id="avg_goal">20</strong>
            <span class="text-xs text-slate-500" data-i18n="hero_widget_note"></span>
          </div>
        </div>
      </div>
    </header>

    <!-- Công cụ -->
    <section class="max-w-6xl mx-auto px-6 mt-14">
      <div class="glass-card rounded-3xl p-6 md:p-8 space-y-6">
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
          <div>
            <h3 class="text-2xl font-bold tracking-wide leading-snug text-slate-700 font-[Sono]" data-i18n="section_title">
              Công cụ trọng tâm của R.E.A.L
            </h3>
          </div>
        </div>

        <div class="grid gap-6 md:grid-cols-3">
          <!-- Card 1: Định giá tham chiếu -->
          <article class="group overflow-hidden rounded-3xl shadow-lg shadow-blue-500/10 ring-1 ring-white/60">
            <div class="relative h-48">
              <img src="https://images.unsplash.com/photo-1532960401447-7dd05bef36a6?auto=format&fit=crop&w=1200&q=80"
                   alt="Reference pricing" class="h-full w-full object-cover transition duration-500 group-hover:scale-105" loading="lazy"/>
              <span class="absolute left-4 top-4 rounded-full bg-white/80 px-3 py-1 text-xs font-medium text-slate-600 shadow" data-i18n="card1_tag">Định giá tham chiếu</span>
            </div>
            <div class="bg-white/85 px-5 py-4">
              <p class="text-sm text-slate-600" data-i18n="card1_text">Xem biên giá theo khu vực, dữ liệu giao dịch gần và lịch sử biến động.</p>
            </div>
          </article>

          <!-- Card 2: Tự đăng & bán P2P -->
          <article class="group overflow-hidden rounded-3xl shadow-lg shadow-blue-500/10 ring-1 ring-white/60">
            <div class="relative h-48">
              <img src="https://images.unsplash.com/photo-1515542622106-78bda8ba0e5a?auto=format&fit=crop&w=1200&q=80"
                   alt="P2P listing" class="h-full w-full object-cover transition duration-500 group-hover:scale-105" loading="lazy"/>
              <span class="absolute left-4 top-4 rounded-full bg-white/80 px-3 py-1 text-xs font-medium text-slate-600 shadow" data-i18n="card2_tag">Tự đăng & bán P2P</span>
            </div>
            <div class="bg-white/85 px-5 py-4">
              <p class="text-sm text-slate-600" data-i18n="card2_text">Người bán tự định giá, tự rao; người mua liên hệ trực tiếp, minh bạch quy trình.</p>
            </div>
          </article>

          <!-- Card 3: Hỗ trợ pháp lý & môi giới -->
          <article class="group overflow-hidden rounded-3xl shadow-lg shadow-blue-500/10 ring-1 ring-white/60">
            <div class="relative h-48">
              <img src="https://images.unsplash.com/photo-1554224155-8d04cb21cd6c?auto=format&fit=crop&w=1200&q=80"
                   alt="Legal & freelance brokers" class="h-full w-full object-cover transition duration-500 group-hover:scale-105" loading="lazy"/>
              <span class="absolute left-4 top-4 rounded-full bg-white/80 px-3 py-1 text-xs font-medium text-slate-600 shadow" data-i18n="card3_tag">Pháp lý & Môi giới</span>
            </div>
            <div class="bg-white/85 px-5 py-4">
              <p class="text-sm text-slate-600" data-i18n="card3_text">AI/luật sư hỗ trợ thủ tục; thuê môi giới freelancer theo nhu cầu thực.</p>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- OVERLAY -->
    <div id="overlay" class="overlay"></div>

    <!-- AUTH PANEL -->
    <div id="loginPanel" class="fixed top-0 right-0 h-full w-full max-w-sm bg-white/95 shadow-2xl slide-out z-50 p-6">
      <button type="button" onclick="closeAuth()" class="absolute right-5 top-5 text-slate-400 hover:text-slate-600">
        <i class="fas fa-times"></i>
      </button>

      <!-- <h3 class="text-xl font-semibold text-slate-900 mb-4">Tài khoản</h3> -->

      <!-- Tabs -->
      <div class="tabs mb-5">
        <button type="button" id="tabLogin" class="tab-btn active" onclick="switchAuthTab('login')">Đăng nhập</button>
        <button id="tabSignup" class="tab-btn" onclick="switchAuthTab('signup')">Đăng ký</button>
      </div>

      <!-- LOGIN -->
      <form id="loginForm" class="space-y-4">
        <div class="flex flex-col gap-2">
          <label for="email" class="text-xs font-medium uppercase tracking-wide text-slate-500" data-i18n="email">Email</label>
          <input type="email" id="email" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" required/>
        </div>
        <div class="flex flex-col gap-2 relative">
          <label for="password" class="text-xs font-medium uppercase tracking-wide text-slate-500" data-i18n="password">Mật khẩu</label>
          <input type="password" id="password" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 pr-10 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" required/>
          <button class="eye-btn" type="button" onclick="toggleEye('password')"><i class="fa-regular fa-eye"></i></button>
        </div>
        <label class="inline-flex items-center gap-2 text-xs text-slate-600">
          <input id="rememberMe" type="checkbox" class="rounded border-slate-300"> Ghi nhớ đăng nhập
        </label>
        <div class="pt-1">
          <button id="loginBtn" type="submit" class="w-full rounded-full bg-blue-500 px-4 py-3 font-medium text-white shadow-lg shadow-blue-500/30 transition hover:-translate-y-0.5 hover:bg-blue-600">
            Đăng nhập
          </button>
        </div>
      </form>

      <!-- SIGNUP -->
      <form id="signupForm" class="space-y-4 hidden">
        <div class="flex flex-col gap-2">
          <label class="text-xs font-medium uppercase tracking-wide text-slate-500">Email</label>
          <input type="email" id="su_email" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" required/>
        </div>
        <div class="flex flex-col gap-2 relative">
          <label class="text-xs font-medium uppercase tracking-wide text-slate-500">Mật khẩu</label>
          <input type="password" id="su_password" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 pr-10 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" minlength="6" required/>
          <button class="eye-btn" type="button" onclick="toggleEye('su_password')"><i class="fa-regular fa-eye"></i></button>
        </div>
        <!-- Field phone (tuỳ chọn) để khớp UserRegister -->
        <div class="flex flex-col gap-2">
          <label class="text-xs font-medium uppercase tracking-wide text-slate-500">Số điện thoại (tuỳ chọn)</label>
          <input type="tel" id="su_phone" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" inputmode="numeric" />
        </div>
        <div class="pt-1">
          <button id="signupBtn" type="submit" class="w-full rounded-full bg-blue-500 px-4 py-3 font-medium text-white shadow-lg shadow-blue-500/30 transition hover:-translate-y-0.5 hover:bg-blue-600">
            Tạo tài khoản
          </button>
        </div>
        <p class="text-xs text-slate-500">Bằng việc đăng ký, bạn đồng ý với điều khoản & chính sách bảo mật.</p>
      </form>
    </div>

    <!-- FAB auth -->
    <div class="fab-wrap" id="fab">
      <div class="fab-tray">
        <button class="fab-btn" onclick="openAuth('login')"><i class="fas fa-right-to-bracket mr-1"></i> Đăng nhập</button>
        <button class="fab-btn" onclick="openAuth('signup')"><i class="fas fa-user-plus mr-1"></i> Đăng ký</button>
      </div>
      <button class="fab-main" id="fabMain" title="Tài khoản">
        <i class="fas fa-user"></i>
      </button>
    </div>
  </div>

  <script>
    // ====== SIMPLE i18n ======
    const I18N = {
      vi: {
        brand_tag: "R.E.A.L",
        brand_title: "Sàn BĐS minh bạch P2P",
        logout: "Đăng xuất",
        login: "Đăng nhập/Đăng ký",
        tab_login: "Đăng nhập",
        tab_signup: "Đăng ký",
        hero_h1: "Real Estate Accountability Layer",
        hero_p: "R.E.A.L là hệ thống BĐS ngang hàng (P2P) nơi người bán tự định giá dựa trên dữ liệu tham chiếu khu vực, tự đăng tin, và kết nối trực tiếp người mua. Nền tảng hỗ trợ môi giới freelancer, tư vấn pháp lý bởi AI/kết nối luật sư, góp phần hình thành thị trường giá lành mạnh và theo dõi giá thật.",
        cta_more: "Khám phá BĐS đang mở bán",
        stat_donors_label: "Người dùng đang hoạt động",
        stat_fund_label: "BĐS đang mở bán",
        hero_widget_title: "Giá tham chiếu khu vực",
        hero_widget_note: "Cập nhật theo giao dịch gần đây",
        section_title: "Công cụ trọng tâm của R.E.A.L",
        card1_tag: "Định giá tham chiếu",
        card1_text: "Xem biên giá theo khu vực, dữ liệu giao dịch gần và lịch sử biến động.",
        card2_tag: "Tự đăng & bán P2P",
        card2_text: "Người bán tự định giá, tự rao; người mua liên hệ trực tiếp, minh bạch quy trình.",
        card3_tag: "Pháp lý & Môi giới",
        card3_text: "AI/luật sư hỗ trợ thủ tục; thuê môi giới freelancer theo nhu cầu thực.",
        email: "Email",
        password: "Mật khẩu",
        phone_optional: "Số điện thoại (tuỳ chọn)",
        remember_me: "Ghi nhớ đăng nhập",
        btn_login: "Đăng nhập",
        btn_signup: "Tạo tài khoản",
        agree_terms: "Bằng việc đăng ký, bạn đồng ý với điều khoản & chính sách bảo mật."
      },
      en: {
        brand_tag: "R.E.A.L",
        brand_title: "Transparent P2P Real Estate",
        logout: "Logout",
        login: "Login/Signup",
        tab_login: "Login",
        tab_signup: "Sign up",
        hero_h1: "Real Estate Accountability Layer",
        hero_p: "R.E.A.L is a peer-to-peer real estate platform where sellers self-price with area reference data, self-list properties, and connect directly with buyers. Get optional freelance brokers and AI/legal support to keep transactions clear, fair, and compliant.",
        cta_more: "Browse active listings ✨",
        stat_donors_label: "Active users",
        stat_fund_label: "Active listings",
        hero_widget_title: "Area reference price",
        hero_widget_note: "Updated from recent transactions",
        section_title: "R.E.A.L core tools",
        card1_tag: "Reference pricing",
        card1_text: "See neighborhood price bands, recent comps, and historical trends.",
        card2_tag: "Self-list & P2P selling",
        card2_text: "Sellers self-price & list; buyers contact directly with full transparency.",
        card3_tag: "Legal & brokers",
        card3_text: "AI/legal counsel for procedures; hire freelance brokers on demand.",
        email: "Email",
        password: "Password",
        phone_optional: "Phone (optional)",
        remember_me: "Remember me",
        btn_login: "Login",
        btn_signup: "Create account",
        agree_terms: "By signing up, you agree to the Terms & Privacy Policy."
      }
    };

    function applyI18n(lang) {
      const dict = I18N[lang] || I18N.vi;
      document.documentElement.lang = lang;
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        if (dict[key]) el.textContent = dict[key];
      });
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      if (email) email.placeholder = dict.email;
      if (password) password.placeholder = dict.password;
      localStorage.setItem("lang", lang);
    }
    function toggleLang() {
      const current = localStorage.getItem("lang") || "vi";
      const next = current === "vi" ? "en" : "vi";
      applyI18n(next);
    }

    // ====== API base ======
    const API_BASE = (function(){
      const env = window.HOPESEED_API_BASE; // optionally injected
      if (env) return env.replace(/\/$/, '');
      const host = location.hostname;
      if (host === 'localhost' || host === '127.0.0.1') return 'http://localhost:8000';
      return '/api'; // Netlify -> Redirect/Proxy đến backend
    })();

    // ====== AUTH HELPERS & UI (khớp main.py) ======
    const API_ROUTES = {
      login: (base) => `${base}/login`,
      register: (base) => `${base}/register`,
    };

    function getToken() { return localStorage.getItem("access_token") || ''; }
    function getEmail() { return localStorage.getItem("user_email") || ''; }

    // Elements
    const overlay = document.getElementById('overlay');
    const panel = document.getElementById('loginPanel');
    const tabLogin = document.getElementById('tabLogin');
    const tabSignup = document.getElementById('tabSignup');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');

    function openAuth(which='login'){
      switchAuthTab(which);
      overlay?.classList.add('show');
      panel?.classList.remove('slide-out');
      panel?.classList.add('slide-in');
    }
    function closeAuth(){
      overlay?.classList.remove('show');
      panel?.classList.remove('slide-in');
      panel?.classList.add('slide-out');
    }
    function switchAuthTab(which){
      const isLogin = which === 'login';
      tabLogin?.classList.toggle('active', isLogin);
      tabSignup?.classList.toggle('active', !isLogin);
      loginForm?.classList.toggle('hidden', !isLogin);
      signupForm?.classList.toggle('hidden', isLogin);
    }
    function toggleEye(inputId){
      const el = document.getElementById(inputId);
      if (!el) return;
      el.type = el.type === 'password' ? 'text' : 'password';
    }
    function toggleLogin(){ openAuth('login'); } // giữ tương thích nút nav

    overlay?.addEventListener('click', closeAuth);
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeAuth(); });

    // FAB
    (function initFab(){
      const fab = document.getElementById('fab');
      const fabMain = document.getElementById('fabMain');
      if (!fab || !fabMain) return;
      fabMain.addEventListener('click', ()=> fab.classList.toggle('open'));
      document.addEventListener('click', (e)=>{
        if (!fab.contains(e.target)) fab.classList.remove('open');
      });
    })();

    function setLoading(btn, isLoading){
      if (!btn) return;
      btn.classList.toggle('btn-loading', isLoading);
      btn.disabled = !!isLoading;
    }

    function updateUIAfterLogin(email){
      const userInfo = document.getElementById('userInfo');
      const accountBtn = document.getElementById('accountBtn');
      const loginToggleBtn = document.getElementById('loginToggleBtn');
      if (userInfo) userInfo.textContent = email || getEmail() || '-';
      if (accountBtn) accountBtn.classList.remove('hidden');
      if (loginToggleBtn) loginToggleBtn.classList.add('hidden');
    }

    // Ensure navbar shows Account when logged-in, Login when not
    async function verifyAuthAndToggleUI(){
      const accountBtn = document.getElementById('accountBtn');
      const loginToggleBtn = document.getElementById('loginToggleBtn');
      const showLogin = ()=>{ accountBtn?.classList.add('hidden'); loginToggleBtn?.classList.remove('hidden'); };
      const showAccount = ()=>{ accountBtn?.classList.remove('hidden'); loginToggleBtn?.classList.add('hidden'); };

      const token = getToken ? getToken() : (localStorage.getItem('access_token')||'');
      if (!token){ showLogin(); return; }
      try {
        const res = await fetch((window.API_BASE||'').replace(/\/$/, '') + '/me', { headers:{ 'Authorization': `Bearer ${token}` }});
        if (!res.ok) throw new Error(String(res.status));
        const me = await res.json().catch(()=>({}));
        updateUIAfterLogin(me?.email || getEmail && getEmail() || '');
        showAccount();
      } catch {
        try { localStorage.removeItem('access_token'); } catch {}
        showLogin();
      }
    }

    async function doLogin(email, password, remember){
      setLoading(loginBtn, true);
      try{
        const res = await fetch(API_ROUTES.login(API_BASE), {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, password })
        });
        const data = await res.json();
        if(!res.ok){ throw new Error(data.detail || 'Đăng nhập thất bại'); }

        // main.py trả: { access_token, is_admin, email, message }
        if (!data.access_token) { throw new Error('Thiếu access_token từ server'); }

        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('user_email', data.email || email);
        if (remember) localStorage.setItem('remember_me','1'); else localStorage.removeItem('remember_me');

        updateUIAfterLogin(data.email || email);
        closeAuth();

        if (data.is_admin === true) location.href = 'monitor.html';
      }catch(err){
        alert(err.message || 'Lỗi kết nối');
      }finally{
        setLoading(loginBtn, false);
      }
    }

      async function doSignup(email, password, phone){
        setLoading(signupBtn, true);
        try{
          const payload = { email, password };
          if (phone) payload.phone = phone; // ĐỂ STRING, đừng Number() để khỏi mất số 0 đầu
          await httpPost(`${API_BASE}/register`, payload);
          try { if (phone) localStorage.setItem('user_phone', phone); } catch {}
          alert('Đăng ký thành công. Vui lòng đăng nhập.');
          switchAuthTab('login');
        }catch(err){
          alert(err.message || 'Đăng ký thất bại');
          console.error('[Register error]', err);
        }finally{
          setLoading(signupBtn, false);
        }
      }
    // Submit handlers
    loginForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const remember = document.getElementById('rememberMe').checked;
      doLogin(email, password, remember);
    });
    signupForm?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const email = document.getElementById('su_email').value.trim();
      const password = document.getElementById('su_password').value;
      const phone = document.getElementById('su_phone').value.trim();
      if (password.length < 6){ alert('Mật khẩu tối thiểu 6 ký tự'); return; }
      doSignup(email, password, phone);
    });

    // Logout
    function logout(){
      localStorage.clear();
      location.reload();
    }
    document.getElementById('accountBtn')?.addEventListener('click', ()=>{
      if (!getToken()) { openAuth('login'); return; }
      location.href = 'user.html';
    });

    // Init on load
    document.addEventListener("DOMContentLoaded", () => {
      applyI18n(localStorage.getItem("lang") || "vi");
      document.getElementById('langBtn')?.addEventListener('click', toggleLang);
      document.getElementById('loginToggleBtn')?.addEventListener('click', toggleLogin);
      verifyAuthAndToggleUI();
      // Sync between tabs
      window.addEventListener('storage', (e)=>{ if (e.key === 'access_token') verifyAuthAndToggleUI(); });
    });
  </script>
</body>
</html>
